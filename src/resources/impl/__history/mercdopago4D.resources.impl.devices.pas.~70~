unit mercdopago4D.resources.impl.devices;

interface

uses
  System.Generics.Collections,
  Data.DB,
  mercdopago4D.resources.interfaces,
  mercdopago4D.interfaces,
  mercdopago4D.http.interfaces,
  mercdopago4D.serializable.paginationdevices,
  mercdopago4D.resources.enums;

type
  TDevices = class(TInterfacedObject, iDevices)
  private
    FConf: iConfiguration;
    FDevies: TPaginationDevices;

    FReturn: iReturns<TPaginationDevices>;

    FHttpCliente: iHttpClient;

    constructor Create(Conf: iConfiguration);
    destructor Destroy; override;
  public
    class function New(Conf: iConfiguration): iDevices;

    function GetDevices: iDevices;
    function AlterOperation(Value: TTipoDevices): iDevices;

    function Returns: iReturns<TPaginationDevices>;
  end;

implementation

uses
  System.SysUtils,
  System.JSON,
  mercdopago4D.http.httpclient,
  mercdopago4D.serializable,
  mercdopago4D.serializable.devices,
  mercdopago4D.resources.impl.Returns;

function TDevices.AlterOperation(Value: TTipoDevices): iDevices;
begin
  Result := Self;
  var lDevice := TDevicesSerialize.New;
  lDevice.OperatingMode := Value.ToString;
  var lJSON := TSerializable<TDevicesSerialize>.New(lDevice);
  FHttpCliente.Body(lJson.ToJSON.ToString).Patch;
end;

constructor TDevices.Create(Conf: iConfiguration);
begin
  FConf := Conf;
  FHttpCliente := THttpClient.New;
  FDevies := TPaginationDevices.New;
end;

destructor TDevices.Destroy;
begin

  inherited;
end;

function TDevices.GetDevices: iDevices;
begin
  Result := Self;
  FHttpCliente
    .BaseURL(TBaseURL.BASEURL.ToString+Format(TResource.POINT.ToString, ['']))
    .Header('Content-Type', 'application/json')
    .Bearer(FConf.AccessToken)
    .Get;
end;

class function TDevices.New(Conf: iConfiguration): iDevices;
begin
  Result := Self.Create(Conf);
end;

function TDevices.Returns: iReturns<TPaginationDevices>;
begin
  if not Assigned(FReturn) then
    FReturn := TReturns<TPaginationDevices>.New(FDevies, FHttpCliente.Content);
  Result := FReturn;
end;

end.
